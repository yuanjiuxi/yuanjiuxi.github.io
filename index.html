<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commander Yuan | PhD Candidate</title>
    <style>
        :root {
            --primary: #8B4513;
            --bg: #fdfcf8;
            --text: #2c3e50;
            --accent-basket: #3498db;
            --accent-cmd: #8e44ad;
        }

        body {
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            touch-action: pan-y;
        }

        /* å¯¼èˆªæ  */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
        }
        .logo { font-weight: bold; font-size: 1.5rem; color: var(--primary); }
        .nav-links a { margin-left: 15px; text-decoration: none; color: var(--text); font-weight: 500; font-size: 0.9rem; transition: 0.3s; }
        .nav-links a:hover { color: var(--accent-basket); }

        /* Header / ç²’å­åŒºåŸŸ */
        header {
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        h1 { font-size: 3rem; margin: 15px 0; color: var(--primary); }
        p.subtitle { font-size: 1.1rem; color: #555; margin-bottom: 30px; font-weight: 300; }
        
        #particle-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px;
        }
        #particle-canvas {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(139, 69, 19, 0.15);
            background: #f0f0f0; 
        }
        
        .social-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .social-btn {
            background: #fff;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        /* å¯¼å¸ˆéƒ¨åˆ† */
        section { padding: 60px 5%; max-width: 1200px; margin: 0 auto; }
        .advisors {
            text-align: center;
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        }
        .advisor-name { font-size: 1.1rem; margin: 10px; display: inline-block; }
        .advisor-name a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed var(--primary); }

        /* è§†é¢‘åŒºåŸŸ */
        #video-section { background: #f9f9f9; text-align: center; width: 100%; padding: 40px 0; }
        video { width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        /* --- æ¸¸æˆé€šç”¨æ ·å¼ --- */
        .game-wrapper {
            border-radius: 20px;
            padding: 30px 10px;
            color: #fff;
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }
        canvas {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            display: block;
            margin: 20px auto;
            cursor: grab;
            touch-action: none;
            max-width: 100%;
        }
        canvas:active { cursor: grabbing; }
        .level-badge {
            background: rgba(0,0,0,0.3);
            padding: 5px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* æ¸¸æˆ 1ï¼šç¯®çƒ (è“è‰²èƒŒæ™¯) */
        #basket-section { background: linear-gradient(135deg, #1e3c72, #2a5298); }
        
        /* æ¸¸æˆ 2ï¼šå¸ä»¤ (ç´«è‰²èƒŒæ™¯) */
        #cmd-section { background: linear-gradient(135deg, #8e44ad, #2980b9); }

        /* ç”»å»Š */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .locked-photo {
            position: relative;
            height: 250px;
            background: #fff; /* æ”¹ä¸ºç™½è‰²èƒŒæ™¯ï¼Œé˜²æ­¢é»‘è¾¹éš¾çœ‹ */
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .locked-photo img {
            width: 100%;
            height: 100%;
            /* å…³é”®ä¿®æ”¹ï¼šæ”¹ä¸º containï¼Œç¡®ä¿ç…§ç‰‡å®Œæ•´æ˜¾ç¤º */
            object-fit: contain; 
            filter: blur(20px) grayscale(100%);
            opacity: 0.5;
            transition: all 1s;
        }
        .locked-photo.unlocked img { filter: none; opacity: 1; }
        .lock-text {
            position: absolute;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 2;
        }
        .locked-photo.unlocked .lock-text { display: none; }

        /* å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 20px;
            text-align: center; width: 300px; transform: scale(0.8);
            transition: transform 0.3s;
        }
        .modal.active .modal-content { transform: scale(1); }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            #particle-canvas, #particle-wrapper { width: 240px; height: 240px; }
            .nav-links a { display: none; } /* æ‰‹æœºç«¯éšè—å¯¼èˆªæ–‡å­— */
            .logo { flex-grow: 1; text-align: center; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Commander Yuan</div>
        <div class="nav-links">
            <a href="#about">About</a>
            <a href="#basket-section">Basketball</a>
            <a href="#cmd-section">Angry Commander</a>
        </div>
    </nav>

    <header id="about">
        <div id="particle-wrapper">
            <canvas id="particle-canvas"></canvas>
        </div>
        
        <h1>åŸä¹…èŒœ (Jiuxi Yuan)</h1>
        <p class="subtitle">Exploring the Micro-World of Irradiation-Resistant Materials</p>
        
        <div class="social-links">
            <a href="https://scholar.google.com/citations?user=5wDcIWYAAAAJ&hl=zh-CN&oi=ao" target="_blank" class="social-btn">Google Scholar</a>
            <button class="social-btn" onclick="showModal('WeChat', 'Tahiti-sunlight')">WeChat</button>
            <button class="social-btn" onclick="showModal('Xiaohongshu', '354980229')">å°çº¢ä¹¦</button>
        </div>
    </header>

    <section>
        <div class="advisors">
            <h2>Academic Advisors</h2>
            <div class="advisor-name">Prof. <a href="https://scholar.google.com/citations?hl=zh-CN&user=PT6XB5UAAAAJ" target="_blank">Ke Jin</a></div>
            <div class="advisor-name">Prof. Xun Guo</div>
            <div style="margin-top:10px; font-size: 0.9rem; color: #666;">Collaborator: Peiwen Yuan</div>
        </div>
    </section>

    <div id="video-section">
        <video controls playsinline>
            <source src="./video.mp4" type="video/mp4">
        </video>
    </div>

    <!-- GAME 1: BASKETBALL -->
    <section id="basket-section" class="game-wrapper">
        <h2>Game 1: 3-Point Contest</h2>
        <p>â†“ Drag down to shoot! (å‘ä¸‹æ‹–æ‹½æŠ•ç¯®)</p>
        <div class="level-badge" id="basket-level">Level 1: Rookie</div>
        
        <canvas id="basket-canvas" width="350" height="500"></canvas>
        
        <div class="gallery-grid">
            <div class="locked-photo" id="bp1"><span class="lock-text">ğŸ”’ Level 1</span><img src="./img4.jpg" alt="Img4"></div>
            <div class="locked-photo" id="bp2"><span class="lock-text">ğŸ”’ Level 2</span><img src="./img5.jpg" alt="Img5"></div>
            <div class="locked-photo" id="bp3"><span class="lock-text">ğŸ”’ Level 3</span><img src="./img6.jpg" alt="Img6"></div>
        </div>
    </section>

    <!-- GAME 2: ANGRY COMMANDER -->
    <section id="cmd-section" class="game-wrapper">
        <h2>Game 2: Angry Commander</h2>
        <p>â† Drag left to launch! (å‘åæ‹–æ‹½å‘å°„å¸ä»¤)</p>
        <div class="level-badge" id="cmd-level">Level 1: First Strike</div>
        
        <canvas id="cmd-canvas" width="600" height="400"></canvas>
        
        <div class="gallery-grid">
            <div class="locked-photo" id="cp1"><span class="lock-text">ğŸ”’ Mission 1</span><img src="./img1.jpg" alt="Img1"></div>
            <div class="locked-photo" id="cp2"><span class="lock-text">ğŸ”’ Mission 2</span><img src="./img2.jpg" alt="Img2"></div>
            <div class="locked-photo" id="cp3"><span class="lock-text">ğŸ”’ Mission 3</span><img src="./img3.jpg" alt="Img3"></div>
        </div>
    </section>

    <!-- å¼¹çª— -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color:var(--primary); margin-top:0;">Title</h3>
            <div style="background:#f1f2f6; padding:10px; font-weight:bold; color:var(--primary); margin:15px 0; user-select:all;" id="modal-text">ID</div>
            <button class="social-btn" onclick="closeModal()" style="background:var(--primary); color:#fff; border:none;">Close</button>
        </div>
    </div>

    <script>
        // --- é€šç”¨å·¥å…· ---
        const modal = document.getElementById('custom-modal');
        function showModal(title, text) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            modal.classList.add('active');
        }
        function closeModal() { modal.classList.remove('active'); }
        modal.addEventListener('click', (e) => { if(e.target===modal) closeModal(); });

        // --- ç²’å­å¤´åƒé€»è¾‘ (ä¿æŒä¸å˜) ---
        const pCanvas = document.getElementById('particle-canvas');
        const pCtx = pCanvas.getContext('2d');
        pCanvas.width = 600; pCanvas.height = 600; pCtx.scale(2, 2); 
        let particles = []; const pMouse = { x: null, y: null, radius: 60 };

        function getPMousePos(evt) {
            const rect = pCanvas.getBoundingClientRect();
            return { x: (evt.clientX-rect.left)*(300/rect.width), y: (evt.clientY-rect.top)*(300/rect.height) };
        }
        pCanvas.addEventListener('mousemove', e => { const p=getPMousePos(e); pMouse.x=p.x; pMouse.y=p.y; });
        pCanvas.addEventListener('touchmove', e => { const p=getPMousePos(e.touches[0]); pMouse.x=p.x; pMouse.y=p.y; }, {passive:true});
        ['mouseleave','touchend'].forEach(evt => pCanvas.addEventListener(evt, () => { pMouse.x=null; pMouse.y=null; }));

        class Particle {
            constructor(x, y, color) {
                this.x=x; this.y=y; this.oX=x; this.oY=y; this.color=color; this.vx=0; this.vy=0;
            }
            update() {
                if (pMouse.x) {
                    const dx = pMouse.x - this.x; const dy = pMouse.y - this.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < pMouse.radius) {
                        const angle = Math.atan2(dy, dx);
                        const force = (pMouse.radius - dist) / pMouse.radius;
                        this.vx -= Math.cos(angle) * force * 40;
                        this.vy -= Math.sin(angle) * force * 40;
                    }
                }
                this.vx *= 0.85; this.vy *= 0.85;
                this.x += this.vx + (this.oX - this.x) * 0.15;
                this.y += this.vy + (this.oY - this.y) * 0.15;
                pCtx.fillStyle = this.color; pCtx.fillRect(this.x, this.y, 2.2, 2.2);
            }
        }
        
        const avatarImg = new Image(); avatarImg.src = './avatar.jpg';
        avatarImg.onload = () => {
            const b = document.createElement('canvas'); b.width=300; b.height=300;
            const bx = b.getContext('2d'); bx.drawImage(avatarImg,0,0,300,300);
            const d = bx.getImageData(0,0,300,300).data;
            for(let y=0; y<300; y+=2) {
                for(let x=0; x<300; x+=2) {
                    const i = (y*300+x)*4;
                    if(d[i+3]>128) particles.push(new Particle(x,y,`rgb(${d[i]},${d[i+1]},${d[i+2]})`));
                }
            }
            animateParticles();
        }
        // Fallback if no avatar
        avatarImg.onerror = () => {
             pCtx.fillStyle='#8B4513'; pCtx.font='100px Arial'; pCtx.fillText('J.Y', 80, 180);
        }
        function animateParticles() {
            pCtx.clearRect(0,0,300,300); particles.forEach(p=>p.update());
            requestAnimationFrame(animateParticles);
        }

        // ==========================================
        // GAME 1: BASKETBALL (ä¼˜åŒ–ç‰©ç†ç¢°æ’)
        // ==========================================
        const bCanvas = document.getElementById('basket-canvas');
        const bCtx = bCanvas.getContext('2d');
        let bLevel = 1;
        let bBall = { x:50, y:420, r:12, vx:0, vy:0, dragging:false, flying:false };
        let bHoop = { x:280, y:220, w:45, dir:1.5 };
        let bDragStart = {x:0, y:0}; let bDragCurr = {x:0, y:0};

        function getBPos(e) {
            const r = bCanvas.getBoundingClientRect();
            const cx = e.touches?e.touches[0].clientX:e.clientX;
            const cy = e.touches?e.touches[0].clientY:e.clientY;
            return { x:cx-r.left, y:cy-r.top };
        }
        bCanvas.addEventListener('mousedown', bStart); bCanvas.addEventListener('touchstart', bStart, {passive:false});
        window.addEventListener('mousemove', bMove); window.addEventListener('touchmove', bMove, {passive:false});
        window.addEventListener('mouseup', bEnd); window.addEventListener('touchend', bEnd);

        function bStart(e) {
            if(bBall.flying) return;
            if(e.cancelable) e.preventDefault();
            const p = getBPos(e);
            if(Math.hypot(p.x-bBall.x, p.y-bBall.y)<50) { bBall.dragging=true; bDragStart=p; bDragCurr=p; }
        }
        function bMove(e) { if(bBall.dragging) { if(e.cancelable) e.preventDefault(); bDragCurr=getBPos(e); } }
        function bEnd() {
            if(bBall.dragging) {
                bBall.dragging=false; bBall.flying=true;
                bBall.vx = (bBall.x - bDragCurr.x)*0.25; bBall.vy = (bBall.y - bDragCurr.y)*0.25;
                // Limit speed
                bBall.vx = Math.min(Math.max(bBall.vx,-20),20); bBall.vy = Math.min(Math.max(bBall.vy,-20),20);
            }
        }
        function updateBasket() {
            bCtx.clearRect(0,0,350,500);
            // Hoop Logic
            if(bLevel===2) { bHoop.x+=1.5*bHoop.dir; if(bHoop.x>300||bHoop.x<150) bHoop.dir*=-1; }
            if(bLevel===3) { bHoop.x+=3*bHoop.dir; if(bHoop.x>310||bHoop.x<120) bHoop.dir*=-1; }

            // Draw Backboard & Rim
            bCtx.fillStyle='#bdc3c7'; bCtx.fillRect(bHoop.x+40, bHoop.y-40, 8, 300); // Post
            
            // Backboard collision area: roughly x+15, width 6
            bCtx.fillStyle='#ecf0f1'; bCtx.fillRect(bHoop.x+15, bHoop.y-50, 6, 60); // Board
            bCtx.strokeStyle='#e74c3c'; bCtx.lineWidth=4; bCtx.beginPath();
            bCtx.moveTo(bHoop.x-bHoop.w/2, bHoop.y); bCtx.lineTo(bHoop.x+15, bHoop.y); bCtx.stroke(); // Rim line

            // Ball Physics
            if(bBall.flying) {
                bBall.vy+=0.5; bBall.x+=bBall.vx; bBall.y+=bBall.vy;
                
                // 1. Wall/Floor Bounce
                if(bBall.y+bBall.r>500) { bBall.y=500-bBall.r; bBall.vy*=-0.6; bBall.vx*=0.8; }
                if(bBall.x>350||bBall.x<0) bBall.vx*=-0.8;

                // 2. Backboard Collision (æ‰“æ¿)
                // Board surface is roughly at bHoop.x + 15
                if(bBall.x + bBall.r > bHoop.x + 15 && bBall.x - bBall.r < bHoop.x + 21 &&
                   bBall.y > bHoop.y - 50 && bBall.y < bHoop.y + 10) {
                     bBall.vx *= -0.7; // Rebound
                     bBall.x = bHoop.x + 15 - bBall.r - 2; // Separate
                }

                // 3. Front Rim Collision (æ‰“å‰æ²¿)
                // Rim front point
                let rimX = bHoop.x - bHoop.w/2;
                let rimY = bHoop.y;
                let dRim = Math.hypot(bBall.x - rimX, bBall.y - rimY);
                if(dRim < bBall.r + 3) {
                    bBall.vx *= -0.8;
                    bBall.vy *= -0.8;
                }

                // Reset Check
                if(Math.abs(bBall.vy)<0.5 && Math.abs(bBall.vx)<0.5 && bBall.y>480) { bBall.flying=false; bBall.x=50; bBall.y=420; }
                
                // Score? (Ball must be moving down, through the hoop width)
                if(bBall.vy>0 && bBall.x>bHoop.x-bHoop.w/2+5 && bBall.x<bHoop.x+10 && Math.abs(bBall.y-bHoop.y)<10) {
                    document.getElementById(`bp${bLevel}`).classList.add('unlocked');
                    if(bLevel<3) { bLevel++; document.getElementById('basket-level').innerText=`Level ${bLevel}`; }
                    bBall.flying=false; bBall.x=50; bBall.y=420;
                    showModal('SWISH!', 'Basket made! Next photo unlocked.'); setTimeout(closeModal, 1500);
                }
            }

            // Draw Line
            if(bBall.dragging) {
                bCtx.beginPath(); bCtx.strokeStyle='rgba(255,255,255,0.6)'; bCtx.moveTo(bBall.x, bBall.y); bCtx.lineTo(bDragCurr.x, bDragCurr.y); bCtx.stroke();
            }

            // Draw Ball
            bCtx.beginPath(); bCtx.fillStyle='#e67e22'; bCtx.arc(bBall.x, bBall.y, bBall.r, 0, Math.PI*2); bCtx.fill();
            requestAnimationFrame(updateBasket);
        }
        updateBasket();


        // ==========================================
        // GAME 2: ANGRY COMMANDER (ä¼˜åŒ–å‘å°„åŠ›åº¦)
        // ==========================================
        const cCanvas = document.getElementById('cmd-canvas');
        const cCtx = cCanvas.getContext('2d');
        const cmdImg = new Image(); cmdImg.src = './commander.png'; 
        
        let cLevel = 1;
        let cBall = { x:120, y:280, r:25, vx:0, vy:0, state:'idle', rot:0 };
        let cDrag = { x:120, y:280 };
        let cTargets = [];
        let cExplosions = []; // çˆ†ç‚¸ç²’å­
        let cTrail = []; // è½¨è¿¹

        function initCmdLevel() {
            cBall.state='idle'; cBall.x=120; cBall.y=280; cBall.vx=0; cBall.vy=0; cBall.rot=0; cTrail=[];
            cTargets = [];
            if(cLevel===1) {
                cTargets.push({x:450,y:310,w:40,h:40,hp:1});
                cTargets.push({x:450,y:270,w:40,h:40,hp:1});
            } else if(cLevel===2) {
                cTargets.push({x:480,y:300,w:40,h:40,hp:1, move:true, oy:300});
                cTargets.push({x:480,y:250,w:40,h:40,hp:1, move:true, oy:250});
            } else {
                cTargets.push({x:520,y:310,w:30,h:30,hp:1}); 
                cTargets.push({x:350,y:250,w:20,h:100,type:'wall'}); // Wall
            }
            document.getElementById('cmd-level').innerText = `Level ${cLevel}: ${cLevel===1?'First Strike':(cLevel===2?'Moving Targets':'The Fortress')}`;
        }

        function getCPos(e) {
            const r = cCanvas.getBoundingClientRect();
            // ä¿®æ­£Canvasç¼©æ”¾
            const sx = cCanvas.width/r.width; const sy = cCanvas.height/r.height;
            const cx = e.touches?e.touches[0].clientX:e.clientX;
            const cy = e.touches?e.touches[0].clientY:e.clientY;
            return { x:(cx-r.left)*sx, y:(cy-r.top)*sy };
        }

        cCanvas.addEventListener('mousedown', cStart); cCanvas.addEventListener('touchstart', cStart, {passive:false});
        window.addEventListener('mousemove', cMove); window.addEventListener('touchmove', cMove, {passive:false});
        window.addEventListener('mouseup', cEnd); window.addEventListener('touchend', cEnd);

        function cStart(e) {
            if(cBall.state!=='idle') return;
            if(e.cancelable) e.preventDefault();
            const p = getCPos(e);
            if(Math.hypot(p.x-120, p.y-280)<80) { cBall.state='dragging'; cDrag=p; }
        }
        function cMove(e) {
            if(cBall.state==='dragging') {
                if(e.cancelable) e.preventDefault();
                let p = getCPos(e);
                let dx = p.x-120; let dy = p.y-280;
                let d = Math.sqrt(dx*dx+dy*dy);
                // å…³é”®ä¿®æ”¹ï¼šå¢åŠ æœ€å¤§æ‹–æ‹½è·ç¦» 100 -> 130
                if(d>130) { p.x=120+dx*(130/d); p.y=280+dy*(130/d); }
                cDrag = p; cBall.x=p.x; cBall.y=p.y;
            }
        }
        function cEnd() {
            if(cBall.state==='dragging') {
                cBall.state='flying';
                // å…³é”®ä¿®æ”¹ï¼šå¢åŠ å¼¹åŠ›ç³»æ•° 0.22 -> 0.35ï¼Œè®©æ‰‹æœºæ›´å®¹æ˜“å°„è¿œ
                cBall.vx = (120 - cBall.x)*0.35; 
                cBall.vy = (280 - cBall.y)*0.35;
            }
        }

        // çˆ†ç‚¸ç²’å­ç³»ç»Ÿ
        function createExplosion(x, y) {
            for(let i=0; i<20; i++) {
                cExplosions.push({
                    x:x, y:y, 
                    vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, 
                    life:1.0, color:`hsl(${Math.random()*60+10}, 100%, 50%)`
                });
            }
        }

        function updateCmd() {
            cCtx.clearRect(0,0,600,400);
            
            // åœ°é¢
            cCtx.fillStyle='#ecf0f1'; cCtx.fillRect(0,350,600,50);

            // ç§»åŠ¨é¶é€»è¾‘
            const time = Date.now()/500;
            cTargets.forEach(t => {
                if(t.move && t.hp>0) t.y = t.oy + Math.sin(time)*40;
            });

            // ç‰©ç†
            if(cBall.state==='flying') {
                cBall.vy += 0.4; 
                cBall.x += cBall.vx; cBall.y += cBall.vy; cBall.rot+=0.2;
                
                // è®°å½•è½¨è¿¹
                if(cTrail.length%3===0) cTrail.push({x:cBall.x, y:cBall.y});

                // è¾¹ç•Œ
                if(cBall.y+cBall.r>350) { 
                    cBall.y=350-cBall.r; cBall.vy*=-0.5; cBall.vx*=0.6; 
                    if(Math.abs(cBall.vx)<0.5 && Math.abs(cBall.vy)<0.5) setTimeout(initCmdLevel, 1000);
                }
                if(cBall.x>600) setTimeout(initCmdLevel, 500);

                // ç¢°æ’æ£€æµ‹
                let activeTargets = 0;
                cTargets.forEach(t => {
                    if(t.hp<=0) return;
                    if(t.type!=='wall') activeTargets++;
                    
                    // AABB Check
                    if(cBall.x+cBall.r > t.x && cBall.x-cBall.r < t.x+t.w &&
                       cBall.y+cBall.r > t.y && cBall.y-cBall.r < t.y+t.h) {
                        
                        if(t.type==='wall') {
                            cBall.vx *= -0.6; // æ’å¢™
                        } else {
                            t.hp = 0; // å‡»æ¯
                            cBall.vy *= 0.6;
                            createExplosion(t.x+t.w/2, t.y+t.h/2);
                        }
                    }
                });

                if(activeTargets===0 && cTargets.length>0 && cBall.state==='flying') {
                    cBall.state='win';
                    document.getElementById(`cp${cLevel}`).classList.add('unlocked');
                    if(cLevel<3) {
                        showModal('BOOM!', `Mission ${cLevel} Complete!`);
                        cLevel++; setTimeout(() => { closeModal(); initCmdLevel(); }, 2000);
                    } else {
                        showModal('VICTORY!', 'Commander, you conquered all levels!');
                    }
                }
            }

            // ç»˜åˆ¶è½¨è¿¹
            cCtx.beginPath();
            cTrail.forEach(p => cCtx.lineTo(p.x, p.y));
            cCtx.strokeStyle = 'rgba(142, 68, 173, 0.3)'; cCtx.lineWidth=4; cCtx.stroke();

            // ç»˜åˆ¶ç›®æ ‡
            cTargets.forEach(t => {
                if(t.hp<=0) return;
                cCtx.fillStyle = t.type==='wall' ? '#7f8c8d' : '#c0392b';
                cCtx.fillRect(t.x, t.y, t.w, t.h);
                // çº¹ç†
                cCtx.strokeStyle='#fff'; cCtx.lineWidth=2; cCtx.strokeRect(t.x, t.y, t.w, t.h);
            });

            // ç»˜åˆ¶å¼¹å¼“å
            cCtx.beginPath(); cCtx.lineWidth=5; cCtx.strokeStyle='#5d4037';
            cCtx.moveTo(105, 280); 
            if(cBall.state==='dragging') cCtx.lineTo(cBall.x, cBall.y); else cCtx.lineTo(120, 280);
            cCtx.stroke();

            // ç»˜åˆ¶å¸ä»¤ (å›¾ç‰‡ä¼˜å…ˆï¼Œå¤±è´¥åˆ™ç”»é»„çƒ)
            cCtx.save();
            cCtx.translate(cBall.x, cBall.y); cCtx.rotate(cBall.rot);
            cCtx.beginPath(); cCtx.arc(0,0,cBall.r,0,Math.PI*2); cCtx.clip();
            
            if(cmdImg.complete && cmdImg.naturalWidth !== 0) {
                cCtx.drawImage(cmdImg, -cBall.r, -cBall.r, cBall.r*2, cBall.r*2);
            } else {
                cCtx.fillStyle='#f1c40f'; cCtx.fill(); cCtx.fillStyle='#000'; cCtx.font='12px Arial'; cCtx.fillText('Cmdr', -14, 4);
            }
            cCtx.restore();

            // ç»˜åˆ¶å¼¹å¼“å‰
            cCtx.beginPath(); cCtx.lineWidth=5; cCtx.strokeStyle='#3e2723';
            cCtx.moveTo(135, 280);
            if(cBall.state==='dragging') cCtx.lineTo(cBall.x, cBall.y); else cCtx.lineTo(120, 280);
            cCtx.stroke();
            
            // ç»˜åˆ¶å¼¹å¼“åº§
            cCtx.fillStyle='#5d4037'; cCtx.fillRect(115, 280, 10, 70);

            // ç»˜åˆ¶çˆ†ç‚¸
            for(let i=cExplosions.length-1; i>=0; i--) {
                let p = cExplosions[i];
                p.life -= 0.05; p.x += p.vx; p.y += p.vy;
                if(p.life<=0) cExplosions.splice(i,1);
                else {
                    cCtx.globalAlpha = p.life; cCtx.fillStyle = p.color;
                    cCtx.beginPath(); cCtx.arc(p.x, p.y, 4, 0, Math.PI*2); cCtx.fill();
                    cCtx.globalAlpha = 1.0;
                }
            }

            requestAnimationFrame(updateCmd);
        }
        initCmdLevel();
        updateCmd();

    </script>
</body>
</html>